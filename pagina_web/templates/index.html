{% extends "base.html" %}
{% block title %}Inicio{% endblock %}

{% block head %}
<style>
  /* === Multi-select con chips (solo estilos del componente) === */
  .ms{ position:relative; }
  .ms__control{
    display:flex; align-items:center; gap:6px; flex-wrap:wrap;
    min-height:40px; padding:6px 36px 6px 10px;
    background:var(--surface); color:var(--fg);
    border:1px solid var(--line); border-radius:8px; cursor:pointer;
  }
  .ms__placeholder{ color:var(--muted); }
  .ms__chip{
    display:inline-flex; align-items:center; gap:6px;
    background:var(--chip); border:1px solid var(--chip-b);
    color:var(--fg); border-radius:999px; padding:4px 8px; font-size:.92rem;
  }
  .ms__chip button{ all:unset; cursor:pointer; padding:0 4px; color:var(--muted); }
  .ms__chev{ position:absolute; right:10px; top:50%; transform:translateY(-50%); pointer-events:none; color:var(--muted); }
  .ms__menu{
    position:absolute; left:0; right:0; z-index:50; margin-top:6px;
    background:var(--surface); border:1px solid var(--line); border-radius:8px;
    box-shadow:0 8px 24px rgba(0,0,0,.25); max-height:260px; overflow:auto; display:none;
  }
  .ms__item{ display:flex; align-items:center; gap:8px; padding:8px 10px; cursor:pointer; }
  .ms__item:hover{ background:rgba(255,255,255,.04); }

  /* Lista / ticket */
  .pill{ border:1px solid var(--line); padding:.1rem .5rem; border-radius:999px; }
  .muted{ color:var(--muted); }
</style>
{% endblock %}

{% block content %}

<form method="get" action="/" class="grid" onsubmit="return false;">
  <input id="search" type="text" name="q" placeholder="Buscar producto... (min. 2 letras)" value="{{ q|default('') }}">

  <div class="grid" style="grid-template-columns:2fr 1fr;gap:8px">
    <!-- Multi-select de supermercados (SIN input de búsqueda interno) -->
    <div id="msStores" class="ms" data-placeholder="Todas las tiendas">
      <div class="ms__control" tabindex="0" aria-haspopup="listbox" aria-expanded="false">
        <span class="ms__placeholder">Todas las tiendas</span>
      </div>
      <div class="ms__chev">▾</div>
      <div class="ms__menu" style="display:none">
        <div class="ms__list" role="listbox" aria-multiselectable="true"></div>
      </div>
    </div>

    <!-- Orden -->
    <select id="sortSelect">
      <option value="recientes">Más recientes</option>
      <option value="unit_asc">€/unidad ↑</option>
      <option value="unit_desc">€/unidad ↓</option>
      <option value="kg_asc">€/kg ↑</option>
      <option value="kg_desc">€/kg ↓</option>
    </select>
  </div>

  <div><button type="button" id="clearBtn">Limpiar</button></div>
</form>

<div style="display:grid;grid-template-columns:2fr 1fr;gap:16px">
  <div>
    <div id="hint" class="muted">Empieza a escribir para ver resultados. Usa al menos 2 letras.</div>

    <!-- ÚNICA tabla de resultados -->
    <table id="tbl" style="display:none">
      <thead>
        <tr>
          <th>Producto</th>
          <th>€/unidad</th>
          <th>€/kg</th>
          <th>Tienda</th>
          <th></th>
          <th>Añadir</th>
        </tr>
      </thead>
      <tbody id="results">
        {% for p in items|default([]) %}
        <tr>
          <td><a href="/product/{{ p.id }}">{{ p.title }}</a></td>
          <td>{{ "%.2f"|format(p.price_unit) }}</td>
          <td>{{ "%.2f"|format(p.price_kg) }}</td>
          <td><span class="pill">{{ p.store }}</span></td>
          <td><a href="/product/{{ p.id }}">Ver</a></td>
          <td>
            <button type="button" class="addBtn"
              data-id="{{ p.id }}"
              data-title="{{ p.title|urlencode }}"
              data-price="{{ p.price_unit }}"
              data-store="{{ p.store|urlencode }}">
              Añadir
            </button>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <aside id="listaPanel" style="border-left:1px solid var(--line);padding-left:12px">
    <h3 style="margin-top:0">Mi lista</h3>
    <div id="listaVacia" class="muted">Vacía. Añade productos →</div>

    <!-- Vista "ticket" -->
    <div id="ticketBox" style="display:none">
      <div style="display:flex;gap:8px;align-items:center;margin-bottom:8px">
        <button id="btnPrint" type="button">Imprimir ticket</button>
        <button id="btnDownload" type="button">Descargar .txt</button>
        <button id="btnClear" type="button" style="margin-left:auto;background:#c23a3a">Vaciar</button>
      </div>

      <div style="background:#111;border:1px solid var(--line);border-radius:12px;padding:12px">
        <div style="font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;font-size:13px;white-space:pre-wrap" id="ticketText"></div>
      </div>

      <ul id="lista" style="list-style:none;padding:0;margin:12px 0 0 0"></ul>

      <div id="ticketTotals" style="margin-top:12px;border-top:1px dashed var(--line);padding-top:10px;display:flex;justify-content:space-between;align-items:center">
        <div class="muted" id="ticketCount"></div>
        <div style="font-weight:600">TOTAL: € <span id="ticketTotal">0.00</span></div>
      </div>
    </div>
  </aside>

  <!-- estilos impresión del ticket -->
  <style>
    @media print{
      header,.grid,#listaPanel button,#tbl,#hint{ display:none !important; }
      #ticketBox{ display:block !important; }
      #ticketText{ font-size:12px; }
      body{ background:#fff; color:#000; }
      .pill{ border:0; }
    }
  </style>
</div>

<script>
  // =========================
  //  Multi-select de tiendas (sin buscador)
  // =========================
  const msEl = document.getElementById('msStores');
  const msControl = msEl.querySelector('.ms__control');
  const msMenu = msEl.querySelector('.ms__menu');
  const msList = msEl.querySelector('.ms__list');
  const msSearch = null; // ← explícitamente sin input de búsqueda
  const msPlaceholder = msEl.dataset.placeholder || 'Selecciona…';

  let allStores = [];
  let selectedStores = new Set();

  function renderChips(){
    msControl.innerHTML = '';
    if(selectedStores.size === 0){
      const span = document.createElement('span');
      span.className = 'ms__placeholder';
      span.textContent = msPlaceholder;
      msControl.appendChild(span);
    }else{
      [...selectedStores].forEach(s=>{
        const chip = document.createElement('span');
        chip.className = 'ms__chip';
        chip.innerHTML = `${s}<button aria-label="Quitar ${s}">✕</button>`;
        chip.querySelector('button').addEventListener('click', (e)=>{
          e.stopPropagation();
          selectedStores.delete(s);
          renderChips();
          renderMenu(''); // sin filtro
          search(input.value);
        });
        msControl.appendChild(chip);
      });
    }
  }

  function renderMenu(){
    const items = allStores; // sin filtro de texto
    msList.innerHTML = items.map(s=>{
      const checked = selectedStores.has(s) ? 'checked' : '';
      return `<div class="ms__item" data-val="${s}">
                <input type="checkbox" ${checked} />
                <span>${s}</span>
              </div>`;
    }).join('');
  }

  function toggleMenu(open){
    const isOpen = open ?? (msMenu.style.display === 'none');
    msMenu.style.display = isOpen ? 'block' : 'none';
    msControl.setAttribute('aria-expanded', String(isOpen));
    if (isOpen) renderMenu();
  }

  // Abrir/cerrar
  msControl.addEventListener('click', ()=> toggleMenu(true));
  document.addEventListener('click', (e)=>{ if(!msEl.contains(e.target)) toggleMenu(false); });
  msControl.addEventListener('keydown', (e)=>{
    if(e.key === 'Enter' || e.key === ' ') { e.preventDefault(); toggleMenu(true); }
  });

  // Selección múltiple
  msList.addEventListener('click', (e)=>{
    const row = e.target.closest('.ms__item'); if(!row) return;
    const val = row.dataset.val;
    if(selectedStores.has(val)) selectedStores.delete(val);
    else selectedStores.add(val);
    renderChips();
    renderMenu();
    search(input.value);
  });

  // Carga de tiendas
  async function loadStores(){
    try{
      const res = await fetch('/api/stores');
      allStores = await res.json();
      allStores.sort((a,b)=> a.localeCompare(b));
      renderChips();
      renderMenu();
    }catch(e){ console.warn('No pude cargar tiendas', e); }
  }

  // =========================
  //   Búsqueda / Resultados
  // =========================
  const sortSelect = document.getElementById('sortSelect');
  const input = document.getElementById('search');
  const clearBtn = document.getElementById('clearBtn');
  const resultsBody = document.getElementById('results');
  const table = document.getElementById('tbl');
  const hint = document.getElementById('hint');

  function eur2(v){ if(v===null||v===undefined||isNaN(v)) return ""; return Number(v).toFixed(2); }
  function eur(v){ return eur2(v); }

  function nowStr(){
    const d = new Date();
    const pad = n => String(n).padStart(2,'0');
    return `${pad(d.getDate())}/${pad(d.getMonth()+1)}/${d.getFullYear()} ${pad(d.getHours())}:${pad(d.getMinutes())}`;
  }

  function imgHtml(p){
    if(!p.image) return '';
    return `<img src="${p.image}" alt="" style="width:160px;height:160px;object-fit:contain;border:1px solid var(--line);border-radius:6px;background:#111;">`;
  }

  function renderRows(items){
    resultsBody.innerHTML = items.map(p => `
      <tr>
        <td>
          <div style="display:flex;align-items:center;gap:8px">
            ${imgHtml(p)}
            <a href="/product/${p.id}">${p.title}</a>
          </div>
        </td>
        <td>${eur2(p.price_unit)}</td>
        <td>${eur2(p.price_kg)}</td>
        <td><span class="pill">${p.store}</span></td>
        <td><a href="/product/${p.id}">Ver</a></td>
        <td>
          <button type="button" class="addBtn"
            data-id="${p.id}"
            data-title="${encodeURIComponent(p.title)}"
            data-price="${p.price_unit}"
            data-store="${encodeURIComponent(p.store)}">
            Añadir
          </button>
        </td>
      </tr>
    `).join('');
  }

  function setState(hasData, loading=false){
    if(loading){
      hint.textContent='Buscando…';
      hint.style.display='block';
      table.style.display='none';
      return;
    }
    if(hasData){
      hint.style.display='none';
      table.style.display='table';
    }else{
      table.style.display='none';
      const q = (input.value||'').trim();
      hint.textContent = q.length < 2
        ? 'Empieza a escribir para ver resultados. Usa al menos 2 letras.'
        : 'Sin resultados.';
      hint.style.display='block';
    }
  }

  async function search(q){
    if(!q || q.trim().length < 2){
      renderRows([]);
      setState(false);
      return;
    }
    setState(false, true);
    try{
      const storesParam = encodeURIComponent([...selectedStores].join(','));
      const url = `/api/products?q=${encodeURIComponent(q)}&store=${storesParam}&sort=${encodeURIComponent(sortSelect.value||'recientes')}`;
      const res = await fetch(url);
      if(!res.ok) throw new Error('HTTP '+res.status);
      const data = await res.json();
      renderRows(data);
      setState(!!(data && data.length > 0));
    }catch(err){
      console.error('Error buscando:', err);
      renderRows([]);
      setState(false);
      hint.textContent = 'Error buscando. Intenta de nuevo.';
    }
  }

  // debounce input
  let t = null;
  input.addEventListener('input', () => {
    clearTimeout(t);
    t = setTimeout(()=> search(input.value), 250);
  });
  sortSelect.addEventListener('change', ()=> search(input.value));
  clearBtn.addEventListener('click', () => {
    input.value='';
    renderRows([]);
    setState(false);
    input.focus();
    selectedStores.clear();
    renderChips();
    renderMenu();
  });

  // =========================
  //   Lista / Ticket (LS)
  // =========================
  const LS_KEY = 'baratazo_lista';
  let cart = {};
  try { cart = JSON.parse(localStorage.getItem(LS_KEY) || '{}'); } catch { cart = {}; }
  function saveCart(){ localStorage.setItem(LS_KEY, JSON.stringify(cart)); }

  function buildTicketLines(cartObj){
    const ids = Object.keys(cartObj);
    const lines = [];
    lines.push('********** BARATAZO **********');
    lines.push(`Fecha: ${nowStr()}`);
    lines.push('------------------------------');
    ids.forEach(id=>{
      const it = cartObj[id];
      const qty = it.qty;
      const pu = Number(it.price_unit)||0;
      const sub = qty*pu;
      lines.push(`x${qty} ${it.title}`);
      lines.push(` @ ${eur(pu)} = ${eur(sub)} [${it.store}]`);
    });
    lines.push('------------------------------');
    const totItems = ids.reduce((a,k)=>a+cartObj[k].qty,0);
    const total = ids.reduce((a,k)=>a+cartObj[k].qty*(Number(cartObj[k].price_unit)||0),0);
    lines.push(`Artículos: ${totItems}`);
    lines.push(`TOTAL: € ${eur(total)}`);
    lines.push('******************************');
    return { text: lines.join('\n'), totItems, total };
  }

  function renderList(){
    const ul = document.getElementById('lista');
    const empty = document.getElementById('listaVacia');
    const ticketBox = document.getElementById('ticketBox');
    const ids = Object.keys(cart);

    if(ids.length === 0){
      ul.innerHTML='';
      empty.style.display='block';
      ticketBox.style.display='none';
      document.getElementById('ticketText').textContent = '';
      document.getElementById('ticketCount').textContent = '';
      document.getElementById('ticketTotal').textContent = '0.00';
      return;
    }

    empty.style.display='none';
    ticketBox.style.display='block';

    ul.innerHTML = ids.map(id => {
      const it = cart[id];
      const sub = (Number(it.price_unit)||0)*it.qty;
      return `
        <li data-id="${id}" style="border:1px dashed var(--line);border-radius:10px;padding:8px;margin-bottom:8px">
          <div style="display:flex;gap:8px;align-items:center">
            <div style="flex:1">
              <div><strong>${it.title}</strong></div>
              <div class="muted">${it.store}</div>
            </div>
            <div style="text-align:right">
              <div class="muted">€/u ${eur(it.price_unit)}</div>
              <div>€ <strong>${eur(sub)}</strong></div>
            </div>
          </div>
          <div style="display:flex;justify-content:flex-end;gap:6px;margin-top:6px">
            <button class="qtyMinus">−</button>
            <input class="qtyInput" type="number" min="1" step="1" value="${it.qty}" style="width:56px;text-align:center;background:#141418;color:var(--fg);border:1px solid var(--line);border-radius:6px;padding:4px 6px">
            <button class="qtyPlus">+</button>
            <button class="removeItem" style="background:#c23a3a">Quitar</button>
          </div>
        </li>
      `;
    }).join('');

    const { text, totItems, total } = buildTicketLines(cart);
    document.getElementById('ticketText').textContent = text;
    document.getElementById('ticketCount').textContent = `Artículos: ${totItems}`;
    document.getElementById('ticketTotal').textContent = eur(total);
  }

  function addToList(p){
    const id = String(p.id);
    if(!cart[id]) cart[id] = { title:p.title, price_unit:p.price_unit, store:p.store, qty:1 };
    else cart[id].qty += 1;
    saveCart();
    renderList();
  }

  // Añadir desde resultados (delegado)
  document.getElementById('results').addEventListener('click', (e) => {
    const btn = e.target.closest('.addBtn');
    if(!btn) return;
    const p = {
      id: btn.dataset.id,
      title: decodeURIComponent(btn.dataset.title),
      price_unit: parseFloat(btn.dataset.price),
      store: decodeURIComponent(btn.dataset.store)
    };
    addToList(p);
  });

  // Controles de la lista (delegado)
  document.getElementById('lista').addEventListener('click', (e) => {
    const li = e.target.closest('li[data-id]');
    if(!li) return;
    const id = li.dataset.id;
    if(e.target.closest('.qtyPlus')) {
      cart[id].qty += 1;
      saveCart(); renderList();
    } else if(e.target.closest('.qtyMinus')) {
      cart[id].qty = Math.max(1, cart[id].qty - 1);
      saveCart(); renderList();
    } else if(e.target.closest('.removeItem')) {
      delete cart[id];
      saveCart(); renderList();
    }
  });

  // input directo de cantidad
  document.getElementById('lista').addEventListener('input', (e)=>{
    const inputQty = e.target.closest('.qtyInput');
    if(!inputQty) return;
    const li = e.target.closest('li[data-id]');
    const id = li.dataset.id;
    const v = Math.max(1, parseInt(inputQty.value||'1',10));
    cart[id].qty = v;
    saveCart(); renderList();
  });

  // botones del ticket
  document.getElementById('btnClear').addEventListener('click', ()=>{
    if(confirm('¿Vaciar la lista?')){
      cart = {};
      saveCart();
      renderList();
    }
  });
  document.getElementById('btnPrint').addEventListener('click', ()=> window.print());
  document.getElementById('btnDownload').addEventListener('click', ()=>{
    const { text } = buildTicketLines(cart);
    const blob = new Blob([text], {type:'text/plain;charset=utf-8'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `baratazo_ticket_${Date.now()}.txt`;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  });

  // =========================
  //  Bootstrap sin buscador interno de tiendas
  // =========================
  (function bootstrap(){
    loadStores();
    setState(false); // tabla oculta hasta que escribas 2+ letras
    renderList();
  })();

</script>

{% endblock %}
